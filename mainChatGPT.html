<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>
<script>
  document
    .getElementById("inputText")
    .addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });
  var usefulThreadId = "";
  var userInputText111 = document.getElementById("inputText").value.trim();
  var currentThreadId = "";
  const threadsData = {};
  let lastSearchSummary = "";
  let currentAssistantId = null;
  var fileIDz = document.getElementById("file_id_get").value;
  var fileIdUploaded = null;
  var assistantIds = "";
  var assistantId = "";
  var sendNOtedfaltru = true;
  var alreadySelectedAssistantId = "asst_xpLeza6gXpg32Nftz6NG5Ss7";
  var storedEmail = sessionStorage.getItem("EmailInSession");
  var userEmail = storedEmail;
  console.log(storedEmail);

  $(document).on("click", ".custom-dropdown-item", function () {
    $(".thread").remove();
    const asstid = $(this).find('input[type="hidden"]').val();
    assistantIds = asstid;
    $(".assistant_details_div").show();
    $(".cux__card-wrappers").show();
    $(".cux__grid-wrapper").show();
    $("#chatMessages").empty();

    fetchThreadsForAssistant(assistantIds);
  });

  if (alreadySelectedAssistantId !== "") {
    assistantIds = alreadySelectedAssistantId;
  }

  async function createThreadUsingAPI(assistantIds) {
    console.log("Assistant IDs:", assistantIds);

    const createNewThreads = {
      url: "https://api.openai.com/v1/threads",
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization:
          "Bearer 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",
        "OpenAI-Beta": "assistants=v2",
      },
    };

    try {
      const response = await fetch(createNewThreads.url, {
        method: createNewThreads.method,
        headers: createNewThreads.headers,
      });

      const data = await response.json();

      if (response.ok && data.id) {
        currentThreadId = data.id;
        $("#threadIdSelected").val(currentThreadId);
        usefulThreadId = currentThreadId;
        $("#currentThreadid").val(currentThreadId);

        if (!threadsData) {
          threadsData = {};
        }

        threadsData[currentThreadId] = [];

        console.log(assistantIds, currentThreadId);

        const dbUrl = `https://mdev.topscripts.in/cohen/createThreads.php?assistant=${assistantIds}&thread=${currentThreadId}&email=${userEmail}`;

        console.log("Sending thread data to database:", {
          assistant_id: assistantIds,
          thread_id: currentThreadId,
        });

        const dbResponse = await fetch(dbUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            assistant_id: assistantIds,
            thread_id: currentThreadId,
          }),
        });

        const dbData = await dbResponse.json();
        console.log("Database response:", dbData);
        createThreadInSidebar(currentThreadId, userInputText111);
      } else {
        console.error("Error creating thread:", data);

        alert("Failed to create thread. Please try again later.");
      }
    } catch (error) {
      console.error("Error creating thread:", error);
    }
  }

  async function fetchThreadsForAssistant(assistantId) {
    const url = `https://mdev.topscripts.in/cohen/getThreads.php?assistant=${assistantId}&email=${userEmail}&_=${Date.now()}`;

    try {
      const response = await fetch(url);
      const threads = await response.json();

      if (response.ok && Array.isArray(threads)) {
        const currentDate = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(currentDate.getDate() - 7);

        threads.forEach((thread) => {
          const lastUpdatedDate = new Date(thread.updated_at);
          if (lastUpdatedDate >= sevenDaysAgo) {
            if (isToday(lastUpdatedDate)) {
              createThreadInSidebar(thread.thread, thread.last_msg);
            } else {
              createThreadInPastSection(thread.thread, thread.last_msg);
            }
          }
        });
      } else {
        console.error("Error fetching threads:", threads);
      }
    } catch (error) {
      console.error("Failed to fetch threads:", error);
    }
  }
  function isToday(date) {
    const today = new Date();
    return (
      date.getDate() === today.getDate() &&
      date.getMonth() === today.getMonth() &&
      date.getFullYear() === today.getFullYear()
    );
  }

  function createThreadInSidebar(threadId, threadTitle) {
    const threadsList = $(".threadsList");
    const thread = document.createElement("div");
    thread.classList.add("thread");

    const truncatedTitle = threadTitle.split(" ").slice(0, 5).join(" ");
    thread.innerHTML = `
                    <div class="thread-content new-chat-added">
                    <span class="thread-icon">
                            <svg width="18" height="45" viewBox="0 0 18 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H15M3 10.5H15M3 15H8.25" stroke="#D9D9D9" 
                                      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        ${truncatedTitle}${
      threadTitle.split(" ").length > 4 ? "..." : ""
    }
                        
                    </div>
                `;

    thread.onclick = function () {
      $(".cux__card-wrappers").hide();
      $(".assistant_details_div").hide();
      setActiveThread(threadId);
    };
    thread.dataset.threadId = threadId;
    threadsList.prepend(thread);
  }

  function createThreadInPastSection(threadId, threadTitle) {
    const pastSection = $(".cux-chat-text");
    const threadWrapper = document.createElement("div");
    threadWrapper.classList.add("thread", "past-thread");

    // Add thread title and SVG icon
    const truncatedTitle = threadTitle.split(" ").slice(0, 4).join(" ");
    threadWrapper.innerHTML = `
                    <div class="thread-content">
                      <span class="thread-icon">
                            <svg width="18" height="45" viewBox="0 0 18 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H15M3 10.5H15M3 15H8.25" stroke="#D9D9D9" 
                                      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        ${truncatedTitle}${
      threadTitle.split(" ").length > 4 ? "..." : ""
    }
                      
                    </div>
                `;

    threadWrapper.onclick = function () {
      $(".cux__card-wrappers").hide();
      $(".assistant_details_div").hide();
      setActiveThread(threadId);
      getActiveThreadMsg(threadId);
    };
    pastSection.append(threadWrapper);
  }

  function setActiveThread(threadId) {
    currentThreadId = threadId;
    usefulThreadId = threadId;

    const threads = document.querySelectorAll(".thread");
    threads.forEach((thread) => {
      thread.classList.remove("active");
      if (thread.dataset.threadId === threadId.toString()) {
        thread.classList.add("active");
      }
    });
  }

  function handleActiveThreadClick() {
    $(".threadsList").on("click", ".thread.active", function () {
      const activeThreadId = $(this).data("thread-id");
      getActiveThreadMsg(activeThreadId);
    });
  }

  handleActiveThreadClick();
  function getActiveThreadMsg(activeThreadId) {
    $.ajax({
      url: `https://api.openai.com/v1/threads/${activeThreadId}/messages`,
      type: "GET",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer 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`,
        "OpenAI-Beta": "assistants=v2",
      },
      success: function (response) {
        if (response) {
          assistantId = assistantIds;
          var imgurl = "";

          var assistantDetails = {
            asst_BAZXFCyPtDugSvsDEMetlNO0:
              "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c7017434df480369d4e3_Frame%207.png",
            asst_Pfl9mO2IQXN5lcMlJUwuyJzk:
              "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701de22bcecff977dfb_Frame%208.png",
            asst_xpLeza6gXpg32Nftz6NG5Ss7:
              "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701e7df684287c9efbe_Frame%209.png",
          };

          if (assistantDetails.hasOwnProperty(assistantId)) {
            imgurl = assistantDetails[assistantId];
          } else {
            console.log("No match found for the given assistantId.");
          }

          $("#chatMessages").empty();

          let allMessagesContent = "";
          let isUserMessage = true;

          response.data.reverse().forEach(function (message) {
            let role = message.role;
            let content = message.content[0].text.value;
            let messageElement = $("<div>");
            const chatMessagesDiv = document.getElementById("chatMessages");

            if (!chatMessagesDiv) {
              console.error("Chat messages container not found");
              return;
            }

            function isPointBased(content) {
              return content
                .split("\n")
                .some(
                  (line) =>
                    line.trim().startsWith("-") ||
                    line.trim().startsWith("•") ||
                    line.trim().match(/^\d+\./)
                );
            }

            if (role === "assistant") {
                const lines = content.split('\n').filter(line => line.trim() !== "");
                                    let formattedContent = "";

                                    lines.forEach(line => {
                                        let trimmedLine = line.trim();

                                        if (/^\d+[\.\)]/.test(trimmedLine)) {
                                            trimmedLine = trimmedLine.replace(/\*\*(.*?)\*\*/, "<strong>$1</strong>"); 
                                            formattedContent += `<span>${trimmedLine}</span><br>`;
                                        }
                                        else if (/^[\*\-]/.test(trimmedLine)) {
                                            formattedContent += `<span style="margin-left: 20px;">${trimmedLine}</span><br>`;
                                        }
                                        else {
                                            formattedContent += `${trimmedLine}<br>`;
                                        }
                                    });

                                    const resDiv = document.createElement('div');
                                    resDiv.classList.add('boat-details');

                                    const img = document.createElement('img');
                                    img.style.width = '45px';
                                    img.style.marginRight = '10px';
                                    img.style.height = '45px';
                                    img.src = imgurl;

                                    resDiv.appendChild(img);

                                    const messageDiv = document.createElement('div');
                                    messageDiv.classList.add("assistant-message");

                                    messageDiv.innerHTML = formattedContent; 

                                    resDiv.appendChild(messageDiv);
                                    chatMessagesDiv.appendChild(resDiv);
            } else if (role === "user") {
              const messageDiv = document.createElement("div");
              messageDiv.classList.add("user-message");

              if (isPointBased(content)) {
                const list = document.createElement("ul");
                list.style.listStyleType = "none";

                const lines = content.split("\n");
                lines.forEach((line) => {
                  const listItem = document.createElement("li");
                  listItem.textContent = line.trim();
                  list.appendChild(listItem);
                });
                messageDiv.appendChild(list);
              } else {
                const paragraph = document.createElement("p");
                paragraph.textContent = content;
                messageDiv.appendChild(paragraph);
              }

              if (message.content[1]?.type === "image_file") {
                var fileID = message.content[1].image_file.file_id;
                $("#chatMessages").append(
                  `<div class="user-message"><img class="src_image" id="file${fileID}" src="" style="max-width: 150px;"></div>`
                );

                console.log("preetete", fileID);

                fetch(`https://api.openai.com/v1/files/${fileID}/content`, {
                  headers: {
                    Authorization:
                      "Bearer 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",
                  },
                })
                  .then((response) => response.blob())
                  .then((blob) => {
                    return new Promise((resolve, reject) => {
                      const reader = new FileReader();
                      reader.onloadend = () => resolve(reader.result);
                      reader.onerror = reject;
                      reader.readAsDataURL(blob);
                    });
                  })
                  .then((base64String) => {
                    console.log("Perfect Response", base64String);

                    const imgElement = document.getElementById(`file${fileID}`);
                    imgElement.src = base64String;
                  })
                  .catch((error) =>
                    console.error("Error fetching image:", error)
                  );
              }

              chatMessagesDiv.appendChild(messageDiv);
            }
          });
        } else {
          console.error("Response does not contain messages array:", response);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error fetching messages:", error);
        alert("An error occurred while fetching the messages.");
      },
    });
  }

  function appendChatMessages(messagesContent) {
    $("#chatMessages").append(messagesContent);
  }

  $(".newThreadButton").click(function () {
    $("#chatMessages").empty();
    createThreadUsingAPI(assistantIds);
    setTimeout(function () {
      $("div.added-thread .thread .thread-content.new-chat-added")
        .first()
        .contents()
        .filter(function () {
          return this.nodeType === 3;
        })
        .remove();
    }, 2000);
  });

  async function sendMessage() {
    setTimeout(() => {}, 300);
    if (assistantIds !== "") {
      const url = `https://mdev.topscripts.in/cohen/getThreads.php?assistant=${assistantId}&email=${userEmail}&_=${Date.now()}`;

      try {
        const response = await fetch(url);
        if (!response.ok)
          throw new Error(`HTTP error! status: ${response.status}`);

        const threads = await response.json();
        if (Array.isArray(threads) && threads.length > 0) {
          const lastThread = threads[threads.length - 1];
        } else {
          console.warn(
            "No threads found or unexpected response format:",
            threads
          );
        }
      } catch (error) {
        console.error("Error fetching threads:", error);
      }
    }

    fileIdUploaded = document.getElementById("file_id_get").value.trim();
    var inputText = document.getElementById("inputText").value.trim();
    userInputText111 = inputText;

    $(".assistant_details_div").hide();
    $(".cux__card-wrappers").hide();
    if (userInputText111) {
      setTimeout(function () {
        const urll = `https://mdev.topscripts.in/cohen/updateMessage.php?assistant=${assistantIds}&thread=${usefulThreadId}&chatmsg=${userInputText111}`;
        const response = fetch(urll);
      }, 2500);

      var imgpath = $("#imagePreview").attr("src");
      if (imgpath != "") {
        $("#chatMessages").append(
          `<div class="user-message"><img class="src_image" src="${imgpath}" style="max-width: 150px;"></div>`
        );
      }

      appendMessage(inputText, "user-message");
      setTimeout(() => {
        const truncatedText = inputText.split(" ").slice(0, 5).join(" ");
        const target = $(
          "div.added-thread .thread .thread-content.new-chat-added"
        ).first();
        if (
          !target
            .contents()
            .filter((_, n) => n.nodeType === 3 && $.trim(n.textContent).length)
            .length
        )
          target.append(
            `${truncatedText}${inputText.split(" ").length > 4 ? "..." : ""}`
          );
      }, 2000);

      appendMessage("loading", "loading-message");

      document.getElementById("inputText").value = "";

      if (currentThreadId === null && usefulThreadId === null) {
        await createThreadUsingAPI();
      }

      var uploadData = null;

      if (fileIdUploaded) {
        uploadData = {
          role: "user",
          content: [
            {
              type: "text",
              text: userInputText111,
            },
            {
              type: "image_file",
              image_file: {
                file_id: fileIdUploaded,
              },
            },
          ],
        };
      } else {
        uploadData = {
          role: "user",
          content: [
            {
              type: "text",
              text: userInputText111,
            },
          ],
        };
      }

      var requestData = uploadData
        ? JSON.stringify(uploadData)
        : JSON.stringify({ question: question });
      usefulThreadId = currentThreadId;
      if (usefulThreadId == "") {
        createThreadUsingAPI(assistantIds);
      }

      if (usefulThreadId == "") {
        setTimeout(() => {
          $.ajax({
            url:
              "https://api.openai.com/v1/threads/" +
              usefulThreadId +
              "/messages",
            type: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization:
                "Bearer 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",
              "OpenAI-Beta": "assistants=v2",
            },
            data: requestData,
            success: function (response) {
              console.log("Message sent successfully:", response);
              messageId = response.id;

              const imageContainer = document.getElementById("imageContainer");
              imageContainer.style.display = "none";
              $("#imagePreview").attr("src", "");
              const fileInput = document.getElementById("fileInput");
              fileInput.value = "";
              document.getElementById("file_id_get").value = "";

              triggerRunOnThread(usefulThreadId);
            },
            error: function (xhr, status, error) {
              console.error("Error sending message:", error);
            },
          });
        }, 5000);
        return false;
      } else {
        $.ajax({
          url:
            "https://api.openai.com/v1/threads/" + usefulThreadId + "/messages",
          type: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization:
              "Bearer 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",
            "OpenAI-Beta": "assistants=v2",
          },
          data: requestData,
          success: function (response) {
            console.log("Message sent successfully:", response);
            messageId = response.id;

            const imageContainer = document.getElementById("imageContainer");
            imageContainer.style.display = "none";
            $("#imagePreview").attr("src", "");
            const fileInput = document.getElementById("fileInput");
            fileInput.value = "";
            document.getElementById("file_id_get").value = "";

            triggerRunOnThread(usefulThreadId);
          },
          error: function (xhr, status, error) {
            console.error("Error sending message:", error);
          },
        });
      }

      function triggerRunOnThread(usefulThreadId) {
        var trigerThreadId = usefulThreadId;
        console.log("Triggering run for thread: " + trigerThreadId);

        var runData = {
          assistant_id: assistantIds,
        };

        fetch("https://api.openai.com/v1/threads/" + trigerThreadId + "/runs", {
          method: "POST",
          headers: {
            Authorization:
              "Bearer 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",
            "Content-Type": "application/json",
            "OpenAI-Beta": "assistants=v2",
          },
          body: JSON.stringify(runData),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Run triggered successfully:", data);
            runCurlRequest(trigerThreadId);
          })
          .catch((error) => {
            console.error("Error triggering run:", error);
          });
      }
      function runCurlRequest(runCurlThreadId) {
        const url = `https://api.openai.com/v1/threads/${runCurlThreadId}/messages`;
        console.log(url);

        $.ajax({
          url: url,
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization:
              "Bearer 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",
            "OpenAI-Beta": "assistants=v2",
          },
          success: function (response) {
            console.log("API Response:", response);

            if (
              !response.data ||
              !Array.isArray(response.data) ||
              response.data.length === 0 ||
              !response.data[0].content ||
              !Array.isArray(response.data[0].content) ||
              response.data[0].content.length === 0 ||
              !response.data[0].content[0].text
            ) {
              console.error("Invalid response structure or missing data");
              setTimeout(() => {
                runCurlRequest(runCurlThreadId);

                $(".cux__grid-wrapper").hide();
              }, 8000);
              return false;
            }

            var lastRole = response.data[0].role;
            var textContent = response.data[0].content[0].text.value;

            if (response.data[0]?.content[1]?.type === "image_file") {
              var fileID = response.data[0].content[1].image_file.file_id;
            }

            if (
              lastRole === "user" ||
              (lastRole === "assistant" && textContent === "")
            ) {
              setTimeout(() => {
                runCurlRequest(runCurlThreadId);
                $(".cux__grid-wrapper").hide();
              }, 5000);
              return false;
            } else {
              const chatMessagesDiv = document.getElementById("chatMessages");
              if (chatMessagesDiv.lastElementChild) {
                chatMessagesDiv.removeChild(chatMessagesDiv.lastElementChild);
              }

              function typeCharacterByCharacter(textContent, appendMessage) {
                let index = 0;
                let typingSpeed = 15;

                var assistantDetails = {
                  asst_BAZXFCyPtDugSvsDEMetlNO0:
                    "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c7017434df480369d4e3_Frame%207.png",
                  asst_Pfl9mO2IQXN5lcMlJUwuyJzk:
                    "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701de22bcecff977dfb_Frame%208.png",
                  asst_xpLeza6gXpg32Nftz6NG5Ss7:
                    "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701e7df684287c9efbe_Frame%209.png",
                };

                if (assistantDetails.hasOwnProperty(assistantIds)) {
                  imgurl = assistantDetails[assistantIds];
                } else {
                  console.log("No match found for the given assistantId.");
                }

                const chatMessagesDiv = document.getElementById("chatMessages");

                const resDiv = document.createElement("div");

                resDiv.classList.add("boat-details");
                const img = document.createElement("img");
                img.style.width = "45px";
                img.style.marginRight = "10px";
                img.style.height = "45px";
                img.src = imgurl;

                resDiv.appendChild(img);

                const messageDiv = document.createElement("div");

                messageDiv.classList.add("bot-message");

                resDiv.appendChild(messageDiv);
                chatMessagesDiv.appendChild(resDiv);
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

                function typeNextCharacter() {
                  const lines = textContent
                    .split("\n")
                    .filter((line) => line.trim() !== "");

                  let formattedContent = "";
                  lines.forEach((line) => {
                    let trimmedLine = line.trim();

                    if (/^\d+[\.\)]/.test(trimmedLine)) {
                      trimmedLine = trimmedLine.replace(
                        /\*\*(.*?)\*\*/,
                        "<strong>$1</strong>"
                      );
                      formattedContent += `<span>${trimmedLine}</span><br>`;
                    } else if (/^[\*\-]/.test(trimmedLine)) {
                      formattedContent += `<span style="margin-left: 20px;">${trimmedLine}</span><br>`;
                    } else {
                      formattedContent += `${trimmedLine}<br>`;
                    }
                  });

                  if (index < formattedContent.length) {
                    messageDiv.innerHTML = formattedContent.slice(0, index + 5);
                    index++;
                    setTimeout(typeNextCharacter, typingSpeed);
                  }
                }

                typeNextCharacter();
              }
              typeCharacterByCharacter(textContent, appendMessage);
            }
          },
          error: function (xhr, status, error) {
            console.error("Error in AJAX request:", status, error);
            $("#chatMessages").html(
              '<div class="error-message">Failed to load messages. Please try again later.</div>'
            );
          },
        });
      }
    } else {
      if (currentThreadId === null || usefulThreadId === null) {
        await createThreadUsingAPI();
      }
      alert("Please enter some text.");
    }
  }

  function appendLoadingMessage() {
    const loadingMessage = { content: "" };

    const messageContainer = document.createElement("div");
    messageContainer.classList.add("message", "bot-message", "loading-dots");
    messageContainer.textContent = loadingMessage.content;
    document.getElementById("chatMessages").appendChild(messageContainer);

    document.getElementById("chatMessages").scrollTop =
      document.getElementById("chatMessages").scrollHeight;
  }

  function appendMessage(message, className) {
    var assistantId = assistantIds;
    var imgurl = "";
    var assistantDetails = {
      asst_BAZXFCyPtDugSvsDEMetlNO0:
        "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c7017434df480369d4e3_Frame%207.png",
      asst_Pfl9mO2IQXN5lcMlJUwuyJzk:
        "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701de22bcecff977dfb_Frame%208.png",
      asst_xpLeza6gXpg32Nftz6NG5Ss7:
        "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701e7df684287c9efbe_Frame%209.png",
    };

    if (assistantDetails.hasOwnProperty(assistantId)) {
      imgurl = assistantDetails[assistantId];
    } else {
      console.log("No match found for the given assistantId.");
    }

    const chatMessagesDiv = document.getElementById("chatMessages");

    const resDiv = document.createElement("div");

    if (className === "bot-message" || className === "assistant-message") {
      resDiv.classList.add("boat-details");

      const img = document.createElement("img");
      img.style.width = "45px";
      img.style.marginRight = "10px";
      img.style.height = "45px";
      img.src = imgurl;

      resDiv.appendChild(img);

      const messageDiv = document.createElement("div");
      messageDiv.classList.add(className);
      messageDiv.textContent = message;
      resDiv.appendChild(messageDiv);
      chatMessagesDiv.appendChild(resDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    } else if (className === "loading-message" && message == "loading") {
      resDiv.classList.add("boat-details");

      const img = document.createElement("img");
      img.style.width = "45px";
      img.style.marginRight = "10px";
      img.style.height = "45px";
      img.src = imgurl;

      resDiv.appendChild(img);

      const messageDiv = document.createElement("div");
      messageDiv.classList.add(className);
      messageDiv.innerHTML =
        '<svg xmlns="http://www.w3.org/2000/svg" width="4em" height="4em" viewBox="0 0 24 24"><circle cx="18" cy="12" r="0" fill="currentColor"><animate attributeName="r" begin=".67" calcMode="spline" dur="1.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="12" r="0" fill="currentColor"><animate attributeName="r" begin=".33" calcMode="spline" dur="1.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="6" cy="12" r="0" fill="currentColor"><animate attributeName="r" begin="0" calcMode="spline" dur="1.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle></svg>';

      resDiv.appendChild(messageDiv);
      chatMessagesDiv.appendChild(resDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    } else {
      const chatMessagesDiv = document.getElementById("chatMessages");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add(className);
      messageDiv.textContent = message;
      chatMessagesDiv.appendChild(messageDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }
  }

  function updateLastSearchSummary(botMessage) {
    const words = botMessage.split(/\s+/);
    const summary = words.slice(0, 5).join(" ");

    lastSearchSummary = summary;

    if (currentThreadId !== null) {
      const thread = document.querySelector(
        `[data-thread-id='${currentThreadId}']`
      );
      if (thread) {
        thread.textContent = lastSearchSummary;
      }
    }
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];

    if (!file) {
      sendMessage();
    } else {
      const validTypes = [
        "image/png",
        "image/jpg",
        "image/jpeg",
        "application/pdf",
        "application/jsonl",
      ];

      if (validTypes.includes(file.type)) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const imageContainer = document.getElementById("imageContainer");
          const imagePreview = document.getElementById("imagePreview");

          imagePreview.src = e.target.result;
          imageContainer.style.display = "block";

          if (file.type.startsWith("image/")) {
            const previewImg = document.createElement("img");
            previewImg.src = e.target.result;
            previewImg.style.maxWidth = "100px";
            imageContainer.appendChild(previewImg);
          } else {
            if (file.type === "application/pdf") {
              alert("PDF uploaded. No preview available.");
            } else {
              alert("File uploaded. No preview available.");
            }
          }
          uploadFileToOpenAI(file);
        };

        reader.readAsDataURL(file);
      } else {
        alert(
          "Invalid file type. Please upload a valid image, PDF, or JSONL file."
        );
      }
    }
  }

  function uploadFileToOpenAI(file) {
    const formData = new FormData();
    formData.append("purpose", "vision");
    formData.append("file", file);

    fetch("https://api.openai.com/v1/files", {
      method: "POST",
      headers: {
        Authorization:
          "Bearer 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",
      },
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.id) {
          console.log("File uploaded successfully. File ID:", data.id);
          fileIdUploaded = data.id;
          document.getElementById("file_id_get").value = data.id;
        } else {
          console.error("Error uploading file:", data);
          alert("Error uploading file. Please try again.");
        }
      })
      .catch((error) => {
        console.error("Error uploading file:", error);
        alert("Error uploading file. Please try again.");
      });
  }

  var settings = {
    url: "https://api.openai.com/v1/assistants?order=desc&limit=20",
    method: "GET",
    timeout: 0,
    headers: {
      "Content-Type": "application/json",
      Authorization:
        "Bearer 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",
      "OpenAI-Beta": "assistants=v2",
      Cookie:
        "__cf_bm=naKGgivhyKvMEyXfOLZKg7I8z1cjoOHZlVIYtViDFSw-1731638619-1.0.1.1-tUuHKT50GcIx86f6KWbjY1bzbCbDV9aeJJ.HJiyoPxWlUCmleMU_VVizIz_Q441xbg_rQSCSJtcXOu5EBvMKsw; _cfuvid=3mKtPGp2v3D9edzWmNf_3YfcRWi5xCuLl.z0B3oak8Q-1731638619190-0.0.1.1-604800000",
    },
  };

  const assistantQuestions = {
    tray: [
      "What are some basics of stock trading?",
      "How can I start investing with low risk?",
      "What tools do traders use to analyze stocks?",
    ],
    cart: [
      "How do I find products to dropship?",
      "What are the steps to start an eCommerce store?",
      "How do I run ads for my online shop?",
    ],
    kerry: [
      "What should I include in my resume?",
      "How can I prepare for job interviews?",
      "What’s the best way to network professionally?",
    ],
  };

  $.ajax(settings).done(function (response) {
    const assistantList = $("#assistant_list");
    const assistantInstruction = $("#assistants_instructions");
    const assistantsImage = $(".Assist_img");
    const cux_grid = $(".cux__grid-wrapper");
    const assistantExperienceDefault = $(".assistant_experince");

    assistantList.empty();

    const assistantImageURLs = [
      "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c7017434df480369d4e3_Frame%207.png",
      "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701de22bcecff977dfb_Frame%208.png",
      "https://cdn.prod.website-files.com/670002990f4e48f1ef7a6e86/6739c701e7df684287c9efbe_Frame%209.png",
    ];

    const assistantProfession = [
      "Tray is your AI-powered trading tutor <br>on Tutorz AI, guiding you through the <br> exciting world of stock market trading.",
      "AI Teacher & Mentor, Specializing in <br>Ecommerce, with a deep focus on<br>Dropshipping.",
      "Kerry is a Career Development<br> Tutor who will take your career<br> and networking skills to the next level",
    ];

    let defaultAssistantTriggered = false;

    response.data.forEach((assistant, index) => {
      const [name, role] = assistant.name.split(" - ");
      var eachAssistId = assistant.id;

      var imageIndex = index % assistantImageURLs.length;
      var assistantImageURL = assistantImageURLs[imageIndex];

      const listItem = $(`
                        <li>
                            <a class="dropdown-item custom-dropdown-item">
                                <input type="hidden" value="${eachAssistId}"/>
                                <div class="assistant-name">${name}</div>
                                <div class="assistant-role">${role}</div>
                            </a>
                        </li>
                    `);

      listItem.on("click", function () {
        $("#chatMessages").empty();
        $("#assistant_button").text(name);
        $("#selected_assistent_chat").text(name);

        const instructions =
          assistant.instructions || "No instructions available.";
        const truncatedInstructions =
          instructions.length > 100
            ? instructions.slice(0, 150) + "..."
            : instructions;
        assistantInstruction.text(truncatedInstructions);

        assistantsImage.html(
          `<img src="${assistantImageURL}" alt="Assistant Image" class="assistant-img">`
        );

        const assistantNameLower = name.toLowerCase();
        const questions = assistantQuestions[assistantNameLower] || [];

        const questionCards = questions
          .map(
            (question, i) => `
                         <div class="mx-0 px-0 col-sm">
                                <div class="cux__card w-md-25 w-100 d-flex align-items-center justify-content-center ${
                                  i === 0 ? "active" : ""
                                }" onclick="sendNoted('${eachAssistId}')">
                                        <input type="hidden" id="inputCardValue" value="${question}"/>
                                        <p class="mb-0">${question}</p>
                                </div>
                            </div>
                        `
          )
          .join("");

        cux_grid.html(questionCards);

        // Show the corresponding profession text
        const professionText =
          assistantProfession[index] || "No profession information available.";
        assistantExperienceDefault.html(professionText);
      });

      assistantList.append(listItem);
      listItem.find(".custom-dropdown-item").trigger("click");
    });
  });

  function sendNoted(assistantId) {
    sendNOtedfaltru = false;

    setTimeout(() => {
      $(".cux__grid-wrapper").empty();
    }, 300);

    console.log("Sending note to assistant with ID:", assistantId);
    
    const clickedCard = event.currentTarget;
    var questionValue = $(clickedCard).find("input[type='hidden']").val();
    if (!questionValue) {
      console.error(
        "No question value found in the hidden input of the clicked card."
      );
      return;
    }

    console.log("Sending noted message:", questionValue);

    assistantIds = assistantId;
    var threadGeneratedId = $("#currentThreadid").val();
    document.getElementById("inputText").value = questionValue;
    userInputText111 = questionValue;

    sendMessage();
  }
  $(document).ready(function () {
    const listItems = document.querySelectorAll("#assistant_list li");

    listItems.forEach((item) => {
      item.addEventListener("click", () => {
        item.classList.add("active");
        fetchThreadsForAssistant(alreadySelectedAssistantId);
      });
    });
  });
</script>
